## 数据缓存架构 
---
<br>

### 1、背景
&emsp;游戏服务器场景中，玩家数据通常分为内存数据和存盘数据，且内存数据往往是比存盘数据更新的。内存数据的特点是易失的，当服务器因为某些原因异常关闭（关闭前没有进行存盘），那么玩家的数据将丢失，这对于玩家来说是不可接受的，对游戏的运营也是一种打击。<br>

&emsp;所以目前游戏服务器场景中，都会对玩家数据进行定期的存盘操作，原因就是尽量减少宕机对玩家的影响，假设我们可以做到每1s保存全部玩家数据，那么宕机最多造成1s内的数据丢失，对玩家来说几乎没有影响。<br>

&emsp;但是我们可以做得到1s存全部玩家吗？在某些情况下，可以做到。但是随着游戏的运营和玩家对象的膨胀，后期玩家存储肯定会遇到瓶颈。<br>

---
<br>

### 2、优化方向

&emsp;我们可以尝试对上面存储玩家数据的问题进行优化。下面将从个人理解的几点提出一些优化方向，并探讨可行性。<br>

1. 减少待存储数据<br>

&emsp;问题的根源是存储对象，那么我们可以考虑是否可以缩减存储数据的数量。如果全量存储就会造成浪费，举几个例子：<br>

* 玩家从上次存盘至本次存盘，数据完全没有发生改变。对于此种情况，我们对其进行存盘其实就是浪费的。
* 玩家从上次存盘至本次存盘，数据小部分发生改变。此情况，我们全量存储，还是浪费了资源。
* 玩家从上次存盘至本次存盘，数据大部分发生改变。此情况，我们全量存储，是最少浪费的。

&emsp;所以推论出，我们在存盘的时候会有一部分数据存储是无效的。那么我们就可以通过优化这方向来提高存储效率。以下是我想出的优化方案：

* 玩家数据分模块，通过对数据模块标脏来对数据进行存储。通过这样的方式我们可以让真正修改的数据进行存储，实际上提高了存储模块的命中率，减少了浪费。但是仍然面临一个问题，划分模块的粒度，此问题我暂时没有想清楚，只能具体分析，如果以后想到好的规则，我会进行修改。
<br>

2. 存储使用异步IO<br>

&emsp;使用异步IO有2个好处，提高IO效率、减少阻塞并提高逻辑服效率；坏处就是引入了异步处理，IO进行和完成后如果需要进行一些业务处理会增加复杂度（但是存储应该和业务完全解耦）。对于异步IO具体如何操作，就不细细讨论了。

3. 提高数据存储频率<br>

&emsp;要提高存储频率，除了上面提过的减少存储数据量，就只有提高存储效率了。围绕这个问题，其实我们可以找到几个解决方案：<br>

* 使用 redis 实现缓存。mysql把数据本地化是一个比较慢的过程，但是如果我们把数据直接缓存在redis中是非常快的，比mysql存储要快几个数量级。不过我们只存储redis是非存盘的，这个时候仍然需要一个服务来将redis中的缓存定期执行本地化。这个方案后续我可能会进行测试并进一步讨论。

* 使用缓存中间件。我们可以编写一个中间件，使用rpc来将需要缓存的数据发送给此中间件，中间件慢慢处理。这个其实就相当于一个消息队列，其本质上和上面使用redis方案类似。好处是自定义程度高可以自由修改中间件功能；缺点就是不够稳定（和程序水平相关）。

&emsp;总结一下，第二种方式我听说过，说明有一定可行性；第一种广泛用在web行业中，所以更稳定，而且redis的稳定带来一个好处，就是防止宕机导致的数据丢失。逻辑服宕机不影响redis。所以我将在后续详尽的实现一下redis解决方案，以及做压测。<br>

---
<br>

### 3、总结

&emsp;最终定下缓存架构设计如下：<br>

* 逻辑服设计一套数据缓存系统。此系统将管理的数据中的脏数据定时写入到redis中；

* redis需要设计配套的数据表，以协助完成数据标脏功能；

* 单独写一个服务，用来定时扫描redis中需要持久化的数据。

&emsp;好处如下：<br>

* IO速度更快，性能更强大。对于在本服进行IO操作的架构来说，将原本本地执行mysql操作拆除为写入redis，相对更快。整个性能瓶颈不再是mysql，而是redis，因此依靠redis内存级别的写入操作获得了更强大的性能；

* 减轻服务器压力。因为我们实际上是把本地化操作转为了微服务的形式，所以我们可以利用微服务的优势，可以将redis和db存储的微服务架设在其他服务器，减轻逻辑服压力。

* 增加服务器容错率。因为IO效率提升，我们存储甚至可以达到1s一次将脏数据写入redis。其次redis和逻辑服不在一个进程内，当逻辑服宕机后，不会导致redis宕机，我们仍然可以后续处理redis中的数据进行存盘。

&emsp;坏处如下：<br>

* 开发难度高。毫无疑问，仍然有很多小公司使用逻辑服直接存储数据的方式，一部分原因就是开发难度高、维护起来也难，自然也增加了成本。

* 非必要要求。对于一些滚服游戏来说，不一定有这么高的要求，所以不会这样做。

* 只保证最终一致性。在设计db微服务的时候，也是要求保证可用 >> 一致性的，个人认为服务不宕机较为重要。其次对于存盘数据，访问时落后几秒甚至几分钟都是可以容忍的。